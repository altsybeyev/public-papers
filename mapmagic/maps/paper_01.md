# Как мы создали топографические карты для пользователей MapMagic. Часть 1: Почему нам понадобились свои карты

Всем привет! Я Влад, сооснователь сервиса планирования маршрутов [MapMagic](https://mapmagic.app/map?b=MM).

У нас есть большая мечта — сделать путешествия на природе доступными для всех людей. Помогать людям создавать красивые маршруты в горах, лесах, по бездорожью и пользоваться ими где угодно: на телефоне в походе, на планшете в кафе, на ноутбуке дома.

Сейчас у нас есть [мобильные приложения](https://mapmagic.app/apps) для Android и iOS, [веб-планировщик маршрутов](https://mapmagic.app/map?b=MM) и [каталог готовых маршрутов](https://mapmagic.app/discover). Естественно, сердце наших сервисов — карты. Но за красивым интерфейсом скрывается непростая история о том, почему мы решили создать собственный картографический пайплайн.

## Проблемы с внешними провайдерами

Когда мы только запускались, делали всё, как многие: использовали готовые решения. Для мобильного приложения — векторные карты от MapTiler, для веба — стандартные тайлы OpenStreetMap и OpenTopoMap для топографического стиля.

Кратко о разнице: **векторные карты** — это когда сервер отдаёт данные (дороги, здания, реки), а клиент рисует их на лету. Плюсы — меньше трафика, можно менять стиль, 3D. **Растровые карты** — это когда сервер отдаёт готовые картинки. Плюсы — проще, быстрее работает при большом количестве объектов.

И всё работало. Пока не начало переставать работать.

Первым пал OpenTopoMap — отличный проект, но у его создателей кончились ресурсы. Сначала сервис ушёл в "survival mode", а затем совсем перестал отвечать из РФ. Для наших пользователей это означало, что в веб-планировщике пропал рельеф — изолинии, перепады высот, всё то, что нужно для планирования маршрута в горах.

OpenStreetMap не содержит рельефа, а использование стандартных тайлов OSM в коммерческом продукте — вопрос времени: когда-нибудь сервис может перестать отдавать тайлы или изменить условия.

С MapTiler вышла классическая история блокировок. Платишь, пользуешься, а потом — бац, и ваши пользователи в одной из стран не могут получить тайлы. Для сервиса, который позиционирует себя как "планируй маршруты где угодно", это критично.

## Что нам нужно было

Из этих проблем мы сформулировали чёткие требования к собственным картам:

| Требование | Почему это важно |
|------------|------------------|
| **Топографический стиль** | Наши пользователи — туристы, альпинисты, велотуристы. Им нужен рельеф, изолинии, перепады высот |
| **Единый стиль для всех платформ** | Карта в мобильном приложении должна выглядеть так же, как в веб-планировщике |
| **Офлайн-режим** | В горах часто нет связи — карты должны скачиваться заранее |
| **Независимость** | Полный контроль над инфраструктурой, никаких внезапных блокировок |
| **Обновляемость** | Возможность обновить данные при изменении в OSM |

Важное требование — дублирование топонимов латиницей. Наши пользователи путешествуют по Грузии, Индии, Японии. Местные названия на грузинском, хинди или японском не читаются, поэтому там, где это возможно, мы дублируем названия латиницей.

## Архитектура решения

Чтобы удовлетворить эти требования, мы спроектировали собственный картографический пайплайн:

```
┌─────────────────────────────────────────────────────────────┐
│                    Источники данных                         │
├─────────────────────────────────────────────────────────────┤
│  • OpenStreetMap (.osm.pbf)                                 │
│  • DEM/mapterhorn (цифровая модель рельефа)                 │
│  • Границы, береговые линии, городские агломерации          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Генерация тайлов                          │
├─────────────────────────────────────────────────────────────┤
│  • Tilemaker — генератор векторных тайлов                   │
│  • Генерация изолиний из DEM                                │
│  • Конвертация в PMTiles                                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     Хранение                                │
├─────────────────────────────────────────────────────────────┤
│  • Object Storage (S3)                                      │
│  • Формат: PMTiles                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Tile Server (Martin)                           │
├─────────────────────────────────────────────────────────────┤
│  • Отдача векторных тайлов                                  │
│  • Кеширование                                              │
│  • Nginx frontend                                           │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│         Рендеринг растровых тайлов                          │
├─────────────────────────────────────────────────────────────┤
│  • Рендеринг векторных тайлов в картинки (tileserver-gl)    │
│  • Балансировка и кеширование отрендеренных тайлов          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Клиенты                                   │
├─────────────────────────────────────────────────────────────┤
│  • MapLibre GL JS (веб, векторные карты)                    │
│  • Leaflet (веб, растровые карты)                           │
│  • Mapbox SDK (мобильное)                                   │
└─────────────────────────────────────────────────────────────┘
```

Ключевые решения:

- **Данные** — OpenStreetMap + DEM от mapterhorn
- **Формат** — PMTiles (оптимизирован для S3)
- **Tileserver** — Martin для векторных тайлов, tileserver-gl для растровых
- **Стиль** — MapLibre Style Specification (работает и в вебе, и на мобильных устрйоствах)

## Что получилось

![](https://static.mapmagic.app/maps/outdoor/screenshots/elbrus_low.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/elbrus_3d.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/elnrus_high.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/orekhovo.png "")


Теперь у нас есть:
- Топографические карты с рельефом, которые работают везде
- Единый стиль для веба и мобильных приложений
- Офлайн-режим для мобильных пользователей
- Полный контроль над данными и инфраструктурой
- Возможность обновлять карты при изменениях в OSM

---

В следующей статье расскажу, откуда берутся данные для наших карт: OpenStreetMap, цифровые модели рельефа, дополнительную геоинформацию и как мы это всё превращаем в тайлы.