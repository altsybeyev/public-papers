# Как мы создали топографические карты для пользователей MapMagic. Часть 1: Почему нам понадобились свои карты

Всем привет! Я Влад, сооснователь [MapMagic](https://mapmagic.app/map?b=MM) — каталога маршрутов и планировщика для пеших походов и велопутешествий.

Сейчас у нас есть [мобильные приложения](https://mapmagic.app/apps) для Android и iOS, [веб-планировщик маршрутов](https://mapmagic.app/map?b=MM) и [каталог готовых маршрутов](https://mapmagic.app/discover).

Сердце нашего сервиса — карты. Мы используем базу OpenStreetMap – Википедию в мире карт, которые рисуются и поддерживаются глобальным сообществом. 

## Проблемы с внешними провайдерами

На старте мы использовали готовые решения. Для мобильного приложения — векторные карты от MapTiler, для веба — стандартные тайлы OpenStreetMap и OpenTopoMap для топографического стиля.

Кратко о разнице: **векторные карты** — это когда сервер отдаёт сырые данные (дороги, здания, реки) в виде геометрий — точек и полигонов, а клиент рисует их на лету. Плюсы — меньше трафика, можно менять стиль, 3D. **Растровые карты** — это когда сервер отдаёт готовые картинки. Плюсы — проще, менее зависивимо от клиента, быстрее работает при большом количестве объектов.

Всё работало стабильно довольно долгое время, но, к сожалению, недавно перестал загружаться из России OpenTopoMap. Для наших пользователей это означало, что в веб-планировщике пропал рельеф — изолинии, перепады высот — всё то, что нужно для планирования маршрута в горах.

Также недавно мы выпустили приложения и нам нужны были офлайн-карты для них. Рассматривали Mapbox и MapTiler. Но отказались от них по трем причинам:
- тарификация запросов по отдельным тайлам у нас быстро бы вышла за все разумные бюджеты;
- не хотелось зависеть от стороннего поставщика карт для снижения риска блокировок;
- хотелось больше возможностей кастомизации карты.

## Что нам нужно было

Из этих проблем мы сформулировали чёткие требования к собственным картам:

| Требование | Почему это важно |
|------------|------------------|
| **Топографический стиль** | Наши пользователи — туристы и велосипедисты. Им нужен рельеф, изолинии, перепады высот |
| **Единый стиль для всех платформ** | Карта в мобильном приложении должна выглядеть так же, как в веб-планировщике |
| **Офлайн-режим** | В горах и лесах часто нет связи — карты должны скачиваться заранее |
| **Независимость** | Полный контроль над инфраструктурой, никаких зависимостей от поставщиков карт |
| **Обновляемость** | Возможность обновить данные при изменении в OSM |

Важное требование — дублирование топонимов латиницей. Наши пользователи путешествуют по Грузии, Индии, Японии. Местные названия на грузинском, хинди или японском не читаются, поэтому там, где это возможно, мы дублируем названия латиницей.

## Архитектура решения

Чтобы удовлетворить эти требования, мы спроектировали собственный картографический пайплайн:

```
┌─────────────────────────────────────────────────────────────┐
│                    Источники данных                         │
├─────────────────────────────────────────────────────────────┤
│  • OpenStreetMap (.osm.pbf)                                 │
│  • DEM/mapterhorn (цифровая модель рельефа)                 │
│  • Границы, береговые линии, городские агломерации          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Генерация тайлов                          │
├─────────────────────────────────────────────────────────────┤
│  • Tilemaker — генератор векторных тайлов                   │
│  • Генерация изолиний из DEM                                │
│  • Конвертация в PMTiles                                    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     Хранение                                │
├─────────────────────────────────────────────────────────────┤
│  • Object Storage (S3)                                      │
│  • Формат: PMTiles                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Tile Server (Martin)                           │
├─────────────────────────────────────────────────────────────┤
│  • Отдача векторных тайлов                                  │
│  • Кеширование                                              │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│         Рендеринг растровых тайлов                          │
├─────────────────────────────────────────────────────────────┤
│  • Рендеринг векторных тайлов в картинки (tileserver-gl)    │
│  • Балансировка и кеширование отрендеренных тайлов          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Клиенты                                   │
├─────────────────────────────────────────────────────────────┤
│  • MapLibre GL JS (веб, векторные карты)                    │
│  • Leaflet (веб, растровые карты)                           │
│  • Mapbox SDK (мобильное)                                   │
└─────────────────────────────────────────────────────────────┘
```

Ключевые решения:

- **Данные** — OpenStreetMap + DEM от mapterhorn
- **Формат** — PMTiles (оптимизирован для S3)
- **Tileserver** — Martin для векторных тайлов, tileserver-gl для растровых
- **Стиль** — MapLibre Style Specification (работает и в вебе, и на мобильных устрйоствах)

## Что получилось

![](https://static.mapmagic.app/maps/outdoor/screenshots/elbrus_low.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/elbrus_3d.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/elnrus_high.png "")
![](https://static.mapmagic.app/maps/outdoor/screenshots/orekhovo.png "")


Теперь у нас есть:
- Топографические карты с рельефом, которые работают везде
- Единый стиль для веба и мобильных приложений
- Офлайн-карты в приложениях
- Полный контроль над данными и инфраструктурой
- Возможность обновлять карты при изменениях в OSM

---

В следующей статье расскажу, откуда берутся данные для наших карт: OpenStreetMap, цифровые модели рельефа, дополнительную геоинформацию и как мы это всё превращаем в тайлы.